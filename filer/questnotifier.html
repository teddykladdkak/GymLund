<!DOCTYPE html>
<html>
<head>
	<title>Quest Notifier</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="yes" name="mobile-web-app-capable" />
	<meta content="minimum-scale=1.0, width=device-width, maximum-scale=0.6667, user-scalable=no" name="viewport" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	<meta property="og:title" content="Quest Notifier" />
	<meta property="og:url" content="https://www.gymlund.tk" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="Listar användares registreringar var quests kan hittas." />
	<meta property="og:image" content="ico/gymlund/icon.jpg" />

	<link rel="shortcut icon" href="ico/gymlund/icon.ico" />
	<link rel="icon" type="image/vnd.microsoft.icon" href="ico/gymlund/icon.ico" />
	<link rel="icon" type="image/png" href="ico/gymlund/icon196x196.png" />
	<link rel="apple-touch-icon-precomposed" href="ico/gymlund/icon180x180.png"/>
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="ico/gymlund/icon76x76.png">
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="ico/gymlund/icon120x120.png">
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="ico/gymlund/icon152x152.png">

	<script src="library/quests.js" type="text/javascript"></script>
	<script src="library/pokestop_malmo.js" type="text/javascript"></script>
	<script type="text/javascript">
		function load() {
			adddataliststop();
			additems();
			getLocation();
			sortbykm();
		};
		function removechilds(parent){while (parent.hasChildNodes()) {parent.removeChild(parent.firstChild);};};
		function adddataliststop(){
			var wrapper = document.getElementById('pokestopdata');
			for (var i = pokestop.length - 1; i >= 0; i--) {
				var option = document.createElement('option');
					option.setAttribute('value', pokestop[i].namn);
				wrapper.appendChild(option);
			};
		};
		function mark(element, id){
			var alltd = document.getElementById('items').getElementsByTagName('img');
			for (var i = alltd.length - 1; i >= 0; i--) {
				alltd[i].removeAttribute('class');
			}
			element.setAttribute('class', 'blue');
			getquests(id);
		};
		function searchstop(element){
			var resultat = [];
			for (var i = pokestop.length - 1; i >= 0; i--) {
				if(pokestop[i].namn.toLowerCase().indexOf(element.value.toLowerCase()) == -1){}else{
					resultat.push(pokestop[i].namn);
				};
			};
			if(resultat.length == 1){
				element.value = resultat[0];
			};
		};
		function additems(){
			var wrapper = document.getElementById('items').getElementsByTagName('tbody')[0];
				var tr = document.createElement('tr');
				var rader = 0;
				rewards.reverse();
				for (var i = rewards.length - 1; i >= 0; i--) {
					if(rader == 5){
						wrapper.appendChild(tr);
						var rader = 0;
						var tr = document.createElement('tr');
					};
					var td = document.createElement('td');
						var img = document.createElement('img');
							img.setAttribute('onclick', 'mark(this, "' + rewards[i].namn + '");');
							img.setAttribute('src', rewards[i].plats);
							img.setAttribute('data-namn', rewards[i].namn);
						td.appendChild(img);
					tr.appendChild(td);
					rader++;
				};
				wrapper.appendChild(tr);
		};
		function getquests(id){
			var questarray = [];
			var numberarray = [];
			for (var i = quests.length - 1; i >= 0; i--) {
				if(quests[i].reward.length == 0){}else{
					for (var a = quests[i].reward.length - 1; a >= 0; a--) {
						if(quests[i].reward[a].typ == id.replace('_', '.')){
							questarray.push(quests[i]);
							numberarray.push(quests[i].reward[a].antal);
						};
					};
				};
			};
			addquest(numberarray, questarray);
		};
		function startoption(text){
			var wrapper = document.getElementById('quests');
				var startoption = document.createElement('option');
					startoption.setAttribute('value', '');
					var startoptiontext = document.createTextNode(text);
					startoption.appendChild(startoptiontext);
				wrapper.appendChild(startoption);
		};
		function addquest(numberarray, questarray){
			var wrapper = document.getElementById('quests');
				wrapper.setAttribute('onchange', 'addnumber(this);')
				activate('deaktivera', 'regbutton');
				activate('deaktivera', 'num');
				activate('deaktivera', 'quests');
				document.getElementById('num').value = '';
				removechilds(wrapper);
			if(questarray.length == 0){
				startoption('Inga quest hittade');
			}else{
				activate('aktivera', 'quests');
				startoption('Välj quest');
				for (var i = questarray.length - 1; i >= 0; i--) {
					var option = document.createElement('option');
						option.setAttribute('value', questarray[i].namn);
						option.setAttribute('data-antal', numberarray[i]);
						option.setAttribute('data-number', questarray[i].number);
						var optiontext = document.createTextNode(questarray[i].namn);
						option.appendChild(optiontext);
					wrapper.appendChild(option);
				};
			};
		};
		function addnumber(element){
			activate('deaktivera', 'regbutton');
			activate('deaktivera', 'num');
			document.getElementById('num').value = '';
			if(element.value == ''){}else{
				var alloptions = element.getElementsByTagName('option');
				for (var i = alloptions.length - 1; i >= 0; i--) {
					if(!alloptions[i].selected){}else{
						if(alloptions[i].getAttribute('data-number') == 'true'){
							activate('aktivera', 'num');
						}else{
							activate('aktivera', 'regbutton');
						};
					};
				};
			};
		};
		function activate(todo, id){
			var button = document.getElementById(id);
			if(todo == 'aktivera'){
				button.removeAttribute('disabled');
			}else{
				button.setAttribute('disabled', 'disabled');
			};
		};
		function checknum(element) {
			var number = element.value.replace(/[^0-9]/, '');
			if(number.length == 0){
				activate('deaktivera', 'regbutton');
			}else{
				activate('aktivera', 'regbutton');
			};
		};
		function showreg(){
			document.getElementById('addbutton').setAttribute('style', 'display: none;');
			document.getElementById('add').removeAttribute('style');
			document.getElementById('wrapper').setAttribute('style', 'display: none;');
		};
		function angra(){
			var alltd = document.getElementById('items').getElementsByTagName('img');
			for (var i = alltd.length - 1; i >= 0; i--) {
				alltd[i].removeAttribute('class');
			};
			removechilds(document.getElementById('quests'));
			activate('deaktivera', 'quests');
			document.getElementById('pokestopnamn').value = '';
			document.getElementById('num').value = '';
			activate('deaktivera', 'num');
			activate('deaktivera', 'regbutton');
			document.getElementById('addbutton').removeAttribute('style');
			document.getElementById('add').setAttribute('style', 'display: none;');
			document.getElementById('wrapper').removeAttribute('style');
		};
		function registrera(){
			//Kontrollera att allt stämmer!
			var pokestop = document.getElementById('pokestopnamn').value;
			var item = document.getElementsByClassName('blue')[0];
			var itemnamn = item.getAttribute('data-namn');
			var itemplats = item.getAttribute('src');
			var quests = document.getElementById('quests').getElementsByTagName('option');
			for (var i = quests.length - 1; i >= 0; i--) {
				if(!quests[i].selected){}else{
					var questomnummer = quests[i].getAttribute('data-number');
					var questvalue = quests[i].getAttribute('value');
					var questantal = quests[i].getAttribute('data-antal');
				};
			};
			if(questomnummer == 'true'){
				var nummer = document.getElementById('num').value;
				var questvalue = questvalue.replace('{?}', nummer);
			};
			var pokestopobj = getpokestopobjekt(pokestop);
			console.log(pokestopobj);
			console.log(itemnamn);
			console.log(itemplats);
			console.log(questvalue);
			console.log(questantal);
			if(pokestop == ''){return false};
			if(!pokestopobj){return false};
			addexample(pokestopobj, itemnamn, itemplats, questvalue, questantal);
			getLocation();
			angra();
		};
		function getpokestopobjekt(pokestopnamn){
			for (var i = pokestop.length - 1; i >= 0; i--) {
				if(pokestop[i].namn.toLowerCase() == pokestopnamn.toLowerCase()){
					return pokestop[i];
				};
			};
		};
		function addexample(pokestopobj, itemnamn, itemplats, questvalue, questantal, givenkm){
			var wrapper = document.getElementById('wrapper');
				var tr = document.createElement('div');
					tr.setAttribute('class', 'tr');
					tr.setAttribute('data-namn', pokestopobj.namn);
					tr.setAttribute('data-longitude', pokestopobj.longitude);
					tr.setAttribute('data-latitude', pokestopobj.latitude);
					tr.setAttribute('data-itemnamn', itemnamn);
					tr.setAttribute('data-itemplats', itemplats);
					tr.setAttribute('data-questvalue', questvalue);
					tr.setAttribute('data-questantal', questantal);
					if(!km){}else{
						tr.setAttribute('data-km', givenkm);
					};
					var km = document.createElement('div');
						km.setAttribute('class', 'td');
						var kmp = document.createElement('p');
							kmp.setAttribute('class', 'km');
							console.log(!km);
							if(!givenkm){
								var kmtext = document.createTextNode('X');
							}else{
								var kmtext = document.createTextNode(givenkm);
							};
							kmp.appendChild(kmtext);
						km.appendChild(kmp);
					tr.appendChild(km);
					var imgwrp = document.createElement('div');
						imgwrp.setAttribute('class', 'td');
						var img = document.createElement('img');
							img.setAttribute('src', itemplats);
						imgwrp.appendChild(img);
					tr.appendChild(imgwrp);
					var st = document.createElement('div');
						st.setAttribute('class', 'td');
						var stp = document.createElement('p');
							var sttext = document.createTextNode(questantal);
							stp.appendChild(sttext);
						st.appendChild(stp);
					tr.appendChild(st);
					var task = document.createElement('div');
						task.setAttribute('class', 'td');
						var taskp = document.createElement('p');
							var tasktext = document.createTextNode(questvalue);
							taskp.appendChild(tasktext);
							taskp.appendChild(document.createElement('br'));
							var pokestopnamn = document.createTextNode(pokestopobj.namn);
							taskp.appendChild(pokestopnamn);
						task.appendChild(taskp);
					tr.appendChild(task);
				wrapper.appendChild(tr);
		};
		function sortbykm(){
			var alllines = document.getElementById('wrapper').getElementsByClassName('tr');
			var data = [];
			var num = [];
			for (var i = alllines.length - 1; i >= 0; i--) {
				if(i == 0){}else{
					num.push(alllines[i].getAttribute('data-km') + '|||' + alllines[i].getAttribute('data-namn'));
					data.push({"km": alllines[i].getAttribute('data-km'), "namn": alllines[i].getAttribute('data-namn'), "longitude": alllines[i].getAttribute('data-longitude'), "latitude": alllines[i].getAttribute('data-latitude'), "itemnamn": alllines[i].getAttribute('data-itemnamn'), "itemplats": alllines[i].getAttribute('data-itemplats'), "questvalue": alllines[i].getAttribute('data-questvalue'), "questantal": alllines[i].getAttribute('data-questantal')})
				};
			};
			num.sort();
			var nyordning = [];
			for (var i = num.length - 1; i >= 0; i--) {
				for (var a = data.length - 1; a >= 0; a--) {
					if(num[i] == data[a].km + '|||' + data[a].namn){
						nyordning.push(data[a]);
					};
				};
			};
			removechilds(document.getElementById('wrapper'));
			addhead();
			for (var i = 0; i < nyordning.length; i++){
				addexample({"namn": nyordning[i].namn, "latitude": nyordning[i].latitude, "longitude": nyordning[i].longitude}, nyordning[i].itemnamn, nyordning[i].itemplats, nyordning[i].questvalue, nyordning[i].questantal, nyordning[i].km);
			};
		};


		function addhead(){
			var wrapper = document.getElementById('wrapper');
				var tr = document.createElement('div');
					tr.setAttribute('class', 'tr');
					var km = document.createElement('div');
						km.setAttribute('class', 'td');
						var kmp = document.createElement('p');
							var kmtext = document.createTextNode('Km');
							kmp.appendChild(kmtext);
						km.appendChild(kmp);
					tr.appendChild(km);
					var imgwrp = document.createElement('div');
						imgwrp.setAttribute('class', 'td');
					tr.appendChild(imgwrp);
					var st = document.createElement('div');
						st.setAttribute('class', 'td');
						var stp = document.createElement('p');
							var sttext = document.createTextNode('St');
							stp.appendChild(sttext);
						st.appendChild(stp);
					tr.appendChild(st);
					var task = document.createElement('div');
						task.setAttribute('class', 'td');
						var taskp = document.createElement('p');
							var tasktext = document.createTextNode('Quest');
							taskp.appendChild(tasktext);
						task.appendChild(taskp);
					tr.appendChild(task);
				wrapper.appendChild(tr);
		};



		var lon = '0';
		var lat = '0';
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			} else {
				//setTimeout(function(){ getLocation(); }, 3000);
				console.log('Något gick fel...');
			};
		};
		function showPosition(position) {
			window['lat'] = position.coords.latitude;
			window['lon'] = position.coords.longitude;
			uppdateDistance();
		};
		function uppdateDistance(){
			var allines = document.getElementById('wrapper').getElementsByClassName('tr');
			for (var i = allines.length - 1; i >= 0; i--) {
				if(i == 0){}else{
					var km = Math.round(getDistanceFromLatLonInKm(allines[i].getAttribute('data-latitude'),allines[i].getAttribute('data-longitude')));
					if(km == NaN){}else{
						allines[i].setAttribute('data-km', km);
						var text = allines[i].getElementsByClassName('km')[0];
							removechilds(text);
						console.log(km);
						var nytext = document.createTextNode(km);
							text.appendChild(nytext);
					};
				};
			};
			sortbykm();
		};
		function getDistanceFromLatLonInKm(lat2,lon2) {
			var lat1 = window['lat'];
			var lon1 = window['lon'];
			if(lat1 == '0'){}else{
				var R = 6371; // Radius of the earth in km
				var dLat = deg2rad(lat2-lat1);  // deg2rad below
				var dLon = deg2rad(lon2-lon1); 
				var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
				var d = R * c; // Distance in km
				//console.log(lat1 + '-' + lon1 + '|' + lat2 + '-' + lon2 + '|' + d + ' km');
				return d;
			};
		};

		function deg2rad(deg) {
			return deg * (Math.PI/180)
		};
	</script>
	<style type="text/css">
		html, body {
			min-height: 100%;
		}
		body {
			background-image: -webkit-linear-gradient(315deg, hsla(0, 0%, 100%, .95), rgba(174, 254, 158, .99));
			background-image: linear-gradient(135deg, hsla(0, 0%, 100%, .95), rgba(174, 254, 158, .99));
		}
		body, select, input {
			font-size: 1.5em;
		}
		select, input {
			display: block;
			width: 100%;
			max-width: 100%;
			margin-bottom: 10px;
		}
		#items {
			text-align: center;
		}
		#add table, #add tr {
			width: 100%;
		}
		#items img:hover {
			background-color: green;
		}
		#items img {
			width: 100%;
			max-width: 129px;
		}
		.blue {
			background-color: blue;
		}
		#wrapper {
			display: table;
			width: 100%;
		}
		#wrapper .tr {
			display: table-row;
		}
		#wrapper .tr .td {
			display: table-cell;
			vertical-align: middle;
			text-align: center;
			padding-right: 10px;
			border-style: ridge;
		}
		#wrapper .tr .td img {
			width: 100%;
			max-width: 60px;
			min-width: 40px;
		}
		#addbutton {
			position: fixed;
    		bottom: 20px;
    		right: 10px;
			display: inline-block;
		    background-color: green;
		    width: 50px;
		    height: 50px;
		    border-radius: 25px;
		    font-size: 2em;
		    font-weight: bold;
		    color: #FFF;
		    text-align: center;
		    padding: 0px;
		}
		h1 {
			font-family: verdana;
			font-size: 1.5em;
			text-align: center;
		}
	</style>
</head>
<body onload="load();">
	<div id="addbutton" onclick="showreg();">+</div>
	<h1>Quest Notifier Malmö</h1>
	<div id="add" style="display: none;">
		<p>1. Välj Pokéstop</p>
		<input type="text" onkeyup="searchstop(this)" onchange="searchstop(this)" list="pokestopdata" id="pokestopnamn" placeholder="Pokestopets namn">
		<p>2. Välj vilket item man får</p>
		<table id="items">
			<tbody></tbody>
		</table>
		<p>3. Välj vilken quest det är</p>
		<select id="quests" disabled="disabled"></select>
		<p>3,5. Ev antal gånger det måste genomföras</p>
		<input type="number" id="num" onkeyup="checknum(this);" onchange="checknum(this);" disabled="disabled">
		<table>
			<tr>
				<td>
					<input type="button" value="Ångra" onclick="angra();">
				</td>
				<td>
					<input type="button" value="Registrera" disabled="disabled" id="regbutton" onclick="registrera();">
				</td>
			</tr>
		</table>
		<datalist id="pokestopdata"></datalist>
	</div>
	<div id="wrapper">
		<div class="tr">
			<div class="td">
				<p>Km</p>
			</div>
			<div class="td">
				
			</div>
			<div class="td">
				<p>St</p>
			</div>
			<div class="td">
				<p>Quest</p><p>
			</p></div>
		</div>
		
		
		<div class="tr" data-namn="Bunker 427" data-longitude="12.899978" data-latitude="55.572132" data-itemnamn="berry_pin" data-itemplats="img/stuff/berry_pin.png" data-questvalue="Spin 4 PokéStops." data-questantal="1" data-km="23">
			<div class="td">
				<p class="km">23</p>
			</div>
			<div class="td">
				<img src="img/stuff/berry_pin.png">
			</div>
			<div class="td">
				<p>1</p>
			</div>
			<div class="td">
				<p>Spin 4 PokéStops.<br>Bunker 427</p>
			</div>
		</div>
		<div class="tr" data-namn="Burlövs gamla kyrka " data-longitude="13.11322" data-latitude="55.636805" data-itemnamn="berry_raz" data-itemplats="img/stuff/berry_raz.png" data-questvalue="Hatch an Egg." data-questantal="3" data-km="9">
			<div class="td">
				<p class="km">9</p>
			</div>
			<div class="td">
				<img src="img/stuff/berry_raz.png">
			</div>
			<div class="td">
				<p>3</p>
			</div>
			<div class="td">
				<p>Hatch an Egg.<br>Burlövs gamla kyrka </p>
			</div>
		</div>
		<div class="tr" data-namn="Sibbarp" data-longitude="12.903928" data-latitude="55.572507" data-itemnamn="stardust" data-itemplats="img/stuff/stardust.png" data-questvalue="Hatch an Egg." data-questantal="400" data-km="23">
			<div class="td">
				<p class="km">23</p>
			</div>
			<div class="td">
				<img src="img/stuff/stardust.png">
			</div>
			<div class="td">
				<p>400</p>
			</div>
			<div class="td">
				<p>Hatch an Egg.<br>Sibbarp</p>
			</div>
		</div>
	</div>
</body>
</html>